{"version":3,"sources":["file:///C:/Users/Administrator/Desktop/TSGFDemo/Demo/%E4%BF%AE%E4%BA%86%E4%B8%AA%E4%BB%99/assets/script/system/SavingManager.ts"],"names":["_decorator","Component","sys","director","em","gUrl","ggd","glf","hr","ccclass","property","SavingManager","_tempData","onLoad","add","savingToTempData","bind","getTempData","savingGlobalDataToTempData","initTempData","addPersistRootNode","node","console","log","initGlobalData","onDestroy","remove","key","data","hasOwnProperty","JSON","parse","stringify","warn","savingTime","userInfo","isVisitor","savingToServer","localStorage","setItem","url","list","savingData","cb","savingToServerComplete","eb","savingToServerError","post","res","string","getTimeDetail","savingInfo","curTime","curTimeStamp","Date","getTime","getItem","accountMetadata","gData","stageProgress","versionCode","scheduleOnce","dispatch"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node, sys, game, director } from 'cc';\r\nimport { em } from '../global/EventManager';\r\nimport { gUrl } from '../global/GameUrl';\r\nimport { ggd } from '../global/globalData';\r\nimport { glf } from '../global/globalFun';\r\nimport { hr } from '../global/HttpRequest';\r\nconst { ccclass, property } = _decorator;\r\n@ccclass('SavingManager')\r\nexport class SavingManager extends Component {\r\n    _tempData = null;\r\n    onLoad() {\r\n        em.add(\"savingToTempData\", this.savingToTempData.bind(this));\r\n        em.add(\"getTempData\", this.getTempData.bind(this));\r\n        em.add(\"savingGlobalDataToTempData\", this.savingGlobalDataToTempData.bind(this));\r\n        this.initTempData();\r\n        director.addPersistRootNode(this.node);//背包物品在各个场景皆可用到 设置为常驻节点\r\n        console.log(\"========================INIT SavingManager===================\");\r\n        this.initGlobalData();\r\n    }\r\n    onDestroy() {\r\n        em.remove(\"savingToTempData\");\r\n        em.remove(\"getTempData\");\r\n    }\r\n    savingToTempData(key, data) {\r\n        //对传入数据进行深拷贝 防止数据污染\r\n        if (this._tempData.hasOwnProperty(key)) this._tempData[key] = JSON.parse(JSON.stringify(data));\r\n        else {\r\n            console.warn(\"添加新属性\" + key);\r\n            console.log(data);\r\n            this._tempData[key] = JSON.parse(JSON.stringify(data));\r\n        }\r\n        console.log(\"temp data，saving key is \" + key, this._tempData);\r\n        this.savingTime();\r\n        if (!ggd.userInfo.isVisitor) this.savingToServer();\r\n        else sys.localStorage.setItem(\"saving\", JSON.stringify(this._tempData));\r\n    }\r\n    savingToServer() {\r\n        let url = gUrl.list.savingData;\r\n        let data = {\r\n            \"configValue\": JSON.stringify(this._tempData),\r\n        }\r\n        let cb = this.savingToServerComplete.bind(this);\r\n        let eb = this.savingToServerError.bind(this);\r\n        hr.post(url, data, cb, eb);\r\n    }\r\n    savingToServerComplete(res) {\r\n        // console.log(\"savingToServerComplete\",res);\r\n    }\r\n    savingToServerError() {}\r\n\r\n    //记录时间\r\n    savingTime() {\r\n        let string = glf.getTimeDetail();\r\n        this._tempData.savingInfo.curTime = string;\r\n        this._tempData.savingInfo.curTimeStamp = new Date().getTime();\r\n    }\r\n    getTempData(key) {\r\n        if (this._tempData.hasOwnProperty(key)) return this._tempData[key];\r\n        else return null;\r\n    }\r\n    initTempData() {\r\n        let data = sys.localStorage.getItem(\"saving\");\r\n        if(!ggd.userInfo.isVisitor) data = ggd.userInfo.accountMetadata;\r\n        if (data) this._tempData = JSON.parse(data);\r\n        else this._tempData = {};\r\n        if (!this._tempData.hasOwnProperty(\"savingInfo\")) {\r\n            this._tempData.savingInfo = {//可能需要修改，时间戳可能存在细微误差\r\n                \"startTime\": glf.getTimeDetail(),\r\n                \"timeStamp\": new Date().getTime(),\r\n                \"curTime\": glf.getTimeDetail(),\r\n                \"curTimeStamp\": new Date().getTime()\r\n            };\r\n        };\r\n    }\r\n    // 初始化全局数据\r\n    initGlobalData() {\r\n        if (this._tempData.hasOwnProperty(\"global\")) {\r\n            let gData = this._tempData[\"global\"];\r\n            ggd.stageProgress = gData.stageProgress;\r\n            if(ggd.versionCode!==gData.versionCode) {\r\n                console.log(\"版本更新\");\r\n                this.savingGlobalDataToTempData();//记录版本号\r\n                this.scheduleOnce(()=>{\r\n                    em.dispatch(\"openVersionNotice\");\r\n                },0);\r\n            }\r\n        }\r\n    }\r\n    // 记录全局数据\r\n    savingGlobalDataToTempData() {\r\n        let key = \"global\";\r\n        let data = {\r\n            \"stageProgress\": ggd.stageProgress,\r\n            \"versionCode\":ggd.versionCode,\r\n        };\r\n        this.savingToTempData(key, data);\r\n    }\r\n}\r\n\r\n"]}