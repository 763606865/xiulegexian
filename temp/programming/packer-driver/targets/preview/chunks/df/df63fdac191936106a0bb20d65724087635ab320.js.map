{"version":3,"sources":["file:///C:/Users/Administrator/Desktop/%E4%BF%AE%E4%BA%86%E4%B8%AA%E4%BB%99/assets/script/hero/weapon/FlySword.ts"],"names":["_decorator","BoxCollider2D","em","ggd","tagData","Weapon","ccclass","property","FlySword","_curTargetRect","_flyState","start","data","dispatch","init","schedule","seekNearestEnemy","lv","initWeaponInfo","weaponName","name","changeSize","x","y","initBoxCollider","sword","stopAll","tree","collider","node","getComponent","rect","worldAABB","res","retrieve","length","Math","random","update","dt","flyToTp","flyToHero","cp","getWorldPosition","width","height","flyDis","_moveSpeed","setPosition","getPosition","rate","sqrt","hwp"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node, BoxCollider2D, find } from 'cc';\r\nimport { em } from '../../global/EventManager';\r\nimport { ggd, tagData } from '../../global/globalData';\r\nimport { Weapon } from './Weapon';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('FlySword')\r\nexport class FlySword extends Weapon {\r\n\r\n    _curTargetRect = null;\r\n    _flyState: number = 0;//0：无状态，初始状态。 1：飞向目标点。 2：飞回玩家身边。\r\n    start() {\r\n        let data = em.dispatch(\"getWeaponDataByIdOrName\", \"flySword\");\r\n        this.init(data, 2);\r\n        this.schedule(() => {\r\n            this.seekNearestEnemy();\r\n        }, 0.5);\r\n    }\r\n    init(data, lv) {\r\n        this.initWeaponInfo(lv, data);\r\n        let weaponName: string = data.name;\r\n        // this.initBoxCollider(tagData.sword);\r\n        let changeSize = {\r\n            x:-20,\r\n            y:-20\r\n        }\r\n        this.initBoxCollider(tagData.sword,changeSize);\r\n    }\r\n    seekNearestEnemy() {\r\n\r\n        if (ggd.stopAll) return;\r\n        if (this._flyState !== 0) return;\r\n        let tree = em.dispatch(\"getCurMonsterQuadtree\");\r\n        let collider = this.node.getComponent(BoxCollider2D);\r\n        let rect = collider.worldAABB;\r\n        let res = tree.retrieve(rect);\r\n        if (res.length) {\r\n            // this._curTargetRect = res.shift();\r\n            this._curTargetRect = res[Math.random()*res.length|0];\r\n            // this.node.parent = find(\"Canvas/bulletLayer\");\r\n            this._flyState = 1;\r\n        }\r\n    }\r\n    update(dt) {\r\n        if (this._flyState == 0) return;\r\n        if (this._flyState == 1) this.flyToTp(dt);\r\n        else if (this._flyState == 2) this.flyToHero(dt);\r\n    }\r\n    flyToTp(dt) {\r\n        if (ggd.stopAll) return;\r\n        // let dis = dt*this._moveSpeed;\r\n        let cp = this.node.getWorldPosition();\r\n        //四叉树位置锁定修正\r\n        let x = this._curTargetRect.x+this._curTargetRect.width/2 - cp.x;\r\n        let y = this._curTargetRect.y+this._curTargetRect.height/2 - cp.y;\r\n        // let x = this._curTargetRect.x - cp.x;\r\n        // let y = this._curTargetRect.y - cp.y;\r\n        let flyDis = dt * this._moveSpeed;\r\n        //可以到达目标点\r\n        if (flyDis * flyDis >= x * x + y * y) {\r\n            this.node.setPosition(this.node.getPosition().x + x, this.node.getPosition().y + y, 0);\r\n            this._curTargetRect = null;\r\n            this._flyState = 2;\r\n        } else {//未到达目标点\r\n            let rate = flyDis / Math.sqrt(x * x + y * y);\r\n            x *= rate;\r\n            y *= rate;\r\n            this.node.setPosition(this.node.getPosition().x + x, this.node.getPosition().y + y, 0);\r\n        }\r\n    }\r\n    flyToHero(dt) {\r\n        if (ggd.stopAll) return;\r\n        let cp = this.node.getWorldPosition();\r\n        let hwp = em.dispatch(\"getHeroWorldPos\");\r\n        let x = hwp.x - cp.x;\r\n        let y = hwp.y - cp.y;\r\n        // let flyDis = dt * this._moveSpeed;\r\n        let flyDis = dt * this._moveSpeed*2;//返回速度是正常速度的两倍\r\n        //可以到达目标点\r\n        if (flyDis * flyDis >= x * x + y * y) {\r\n            this.node.setPosition(this.node.getPosition().x + x, this.node.getPosition().y + y, 0);\r\n            this._flyState = 0;\r\n        } else {//未到达目标点\r\n            let rate = flyDis / Math.sqrt(x * x + y * y);\r\n            x *= rate;\r\n            y *= rate;\r\n            this.node.setPosition(this.node.getPosition().x + x, this.node.getPosition().y + y, 0);\r\n        }\r\n    }\r\n\r\n}\r\n\r\n"]}